<div class="estimates-wrapper">
  <div class="top-bar">
    <div class="tabs">
      <span [class.active]="activeTab === 'all'" (click)="switchTab('all')">All Estimates</span>
      <span [class.active]="activeTab === 'pending'" (click)="switchTab('pending')">Payment Due</span>
      <span [class.active]="activeTab === 'paid'" (click)="switchTab('paid')">Paid by Client</span>
    </div>
<div class="actions">
  <button class="btn export-btn">Export Report</button>

  <button class="btn icon-btn" (click)="toggleSearch()" [class.active]="showSearchBar">
    <i class="fas fa-search"></i>
  </button>
  <button #filterBtn
          type="button"
          class="btn icon-btn"
          (click)="openFilterPopover()">
    <i class="fas fa-filter"></i> Filter
   
  </button>
</div>

  <mat-form-field appearance="fill" class="position-absolute " style="opacity: 0; pointer-events: none;  height: 0;  width: 0;">
  <mat-date-range-picker 
    #filterPopover


>
    
    <mat-date-range-input [rangePicker]="filterPopover">
      <input matStartDate 
             [(ngModel)]="dateRange.start" 
             placeholder="Start date"
             readonly>
      <input matEndDate 
             [(ngModel)]="dateRange.end" 
             placeholder="End date"
             readonly>
    </mat-date-range-input>

    <mat-datepicker-toggle matIconSuffix [for]="filterPopover"></mat-datepicker-toggle>

    <mat-date-range-picker-actions>
      <button mat-button matDateRangePickerCancel (click)="clearDateFilter()">
        Cancel
      </button>
      <button mat-button 
              color="primary" 
              matDateRangePickerApply>
        Apply
      </button>
    </mat-date-range-picker-actions>
  </mat-date-range-picker>
</mat-form-field>




</div>
  <div 
    class="search-dropdown shadow-sm border w-25 rounded-3 p-2 bg-white"
    *ngIf="showSearchBar">
    
    <div class="input-group input-group-sm ">
      <input 
        #searchInput
        type="text" 
        class="form-control form-control-sm border-0"
        placeholder="Search ..."
        [(ngModel)]="searchTerm"/>

    </div>
  </div>
  <div class="table-wrapper">
    <table class="table table-striped w-100">
      <thead>
        <tr>
          <th>#No.</th>
          <th>Client Name</th>
          <th>Amount</th>
          <th>BDE</th>
          <th>Date</th>
          <th>Status</th>
          <th>...</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let estimate of filteredEstimates; trackBy: trackById" 
    [id]="'estimate-row-' + estimate.id"
    class="estimate-row">
          <td>{{ estimate.id }}</td>
          <td>{{ estimate.client_Name }}</td>
          <td>{{ estimate.estimate_Amount }}</td>
          <td>{{ estimate.member_Name }}</td>
          <td>{{ estimate.invoiceDate }}</td>
          <td>
            <span [ngClass]="{
              'status-pill': true,
              'pending': normalizeStatus(estimate?.payment_Status) === 'PENDING',
              'paid': normalizeStatus(estimate?.payment_Status) === 'PAYMENT DONE'
            }"
            title="Raw: '{{estimate?.payment_Status}}' | Normalized: '{{normalizeStatus(estimate?.payment_Status)}}'">
              {{normalizeStatus(estimate?.payment_Status)}}
            </span>
          </td>
           <td class="action-cell">
    <div class="dropdown d-inline-block">
      <button class="btn btn-link p-0 text-muted"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"> â‹® </button>

      <ul class="dropdown-menu dropdown-menu-end" >
        <li>
          <a class="dropdown-item d-flex align-items-center" (click)="exportPdf(estimate)"> 
                    <i class="fas fa-download me-2"></i> Download 
                  </a>
        </li>
        <li>
          <a class="dropdown-item d-flex align-items-center"
             href="javascript:void(0)"
             (click)="edit(estimate)">
            <i class="fas fa-edit me-2"></i> Edit
          </a>
        </li>
        <li>
          <a class="dropdown-item d-flex align-items-center text-danger"
             href="javascript:void(0)"
             (click)="delete(estimate)">
            <i class="fas fa-trash-alt me-2"></i> Delete
          </a>
        </li>
        <li>
  <a class="dropdown-item d-flex align-items-center"
     href="javascript:void(0)"
     (click)="handlePaymentAction(estimate)">
    <i class="fas fa-paper-plane me-2"></i>
    {{ getPaymentActionText(estimate?.payment_Status) }}
  </a>
</li>
      </ul>
    </div>
  </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>